<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><title>Thanish.me - Multiplayer Tetris Game (part 2)</title><meta name="description" content="This tutorial validates the design we used to write code on part 1. We will try whether it&#x27;s possible to fix bugs easily and whether we can add some new features to the game without major code/design changes."/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/7f70020d85390dd3a34d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7f70020d85390dd3a34d.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-45110e586e5b9bc00f35.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.cdbdac0a36200f52203c.js" as="script"/><link rel="preload" href="/_next/static/chunks/afe4269f325c6b8604421e2a8f7bec7a7b2019c2.6c26eafa6145d614ef25.js" as="script"/><link rel="preload" href="/_next/static/chunks/3ef630e34cd10ba68f9d468ac363ff81c534e1e9.4a5474eceaa2247b7ab4.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-f02ce07924e8fedfef57.js" as="script"/><link rel="preload" href="/_next/static/chunks/ec66151a9e4e24d8cdbbe349a286441475ff64c5.7ffadac7dd0f7e019b2c.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/2021-01-24-multiplayer-tetris-game-part-2-6a1cc666820199740850.js" as="script"/></head><body><div id="__next"><main class="markdown-body"><article><header class="page-header"><a href="/" class="page-header-title">Thanish.me</a><a href="/" class="page-header-subtitle">dd if=/dev/head of=/dev/blog</a></header><header><h1 class="post-head">Multiplayer Tetris Game (part 2)</h1><p class="post-meta"><small>Posted on <!-- -->2021-01-24</small></p><main><section><p>This tutorial validates the design we used to write code on part 1. We will try whether it&#x27;s possible to fix bugs easily and whether we can add some new features to the game without major code/design changes.</p><p>Did it work? uou can try the updated game here (Instructions: click to focus and use ↑←↓→ keys and WASD keys)</p><div style="display:flex;height:400px;border:dashed 1px #aaa;margin:16px 0"><button style="flex:1;border:none;background:none;outline:none;font-size:18px;cursor:pointer">Click Here</button></div></section></main></header><main><h2>Fixing Bugs in the code</h2><p>It turns out, the &quot;T&quot; shape passes through other shapes unless the block on the bottom touches. Let&#x27;s have a look at one of the requirements we started with on part 1.</p><ul><li>R2.3: The active shape moves 1 unit downwards every 0.5 seconds until <em>it lands</em> on the floor or on another shape.</li></ul><p>Let&#x27;s define the requirement better.</p><ul><li>R2.3: The active shape moves 1 unit downwards every 0.5 seconds until <em>any of the blocks in the active shape lands</em> on the floor or on another shape.</li></ul><p>Here&#x27;s the code that is supposed to handle this scenario.</p><pre><code class="language-js">const isBlockedFromBottom = (simulated, activeShape, playerShapes) =&gt; {
  if (simulated.type === activeShape.type &amp;&amp; simulated.y &lt;= activeShape.y) {
    return null;
  }
  if (simulated.y + simulated.type.length &gt; options.worldHeight) {
    return RULE_ACTIONS.CREATE_SHAPE;
  }
  for (let [shape, isActive] of getOtherShapes(activeShape, playerShapes)) {
    if (!doesBBoxOverlap(simulated, shape)) {
      continue;
    }
    const row = simulated.type.length - 1;
    for (let col = 0; col &lt; simulated.type[0].length; ++col) {
      if (doesBlockOverlap(simulated, row, col, shape)) {
        if (simulated.y &lt;= 0) {
          return RULE_ACTIONS.END_THE_GAME;
        }
        if (isActive) {
          return RULE_ACTIONS.BLOCK_ACTION;
        }
        return RULE_ACTIONS.CREATE_SHAPE;
      }
    }
  }
  return null;
};
</code></pre><p>Instead of only checking the last row, we can check all the blocks with a bottom edge open.
And here&#x27;s the same code with the fix.</p><pre><code class="language-js">const isBlockedFromBottom = (simulated, activeShape, playerShapes) =&gt; {
  if (simulated.type === activeShape.type &amp;&amp; simulated.y &lt;= activeShape.y) {
    return null;
  }
  if (simulated.y + simulated.type.length &gt; options.worldHeight) {
    return RULE_ACTIONS.CREATE_SHAPE;
  }
  for (let [shape, isActive] of getOtherShapes(activeShape, playerShapes)) {
    if (!doesBBoxOverlap(simulated, shape)) {
      continue;
    }
    for (let col = 0; col &lt; simulated.type[0].length; ++col) {
      let prevVal = 0;
      for (let row = simulated.type.length - 1; row &gt;= 0; --row) {
        const val = simulated.type[row][col];
        if (val &amp;&amp; !prevVal) {
          if (doesBlockOverlap(simulated, row, col, shape)) {
            if (simulated.y &lt;= 0) {
              return RULE_ACTIONS.END_THE_GAME;
            }
            if (isActive) {
              return RULE_ACTIONS.BLOCK_ACTION;
            }
            return RULE_ACTIONS.CREATE_SHAPE;
          }
        }
        prevVal = val
      }
    }
  }
  return null;
};
</code></pre><p>But how do we know that the change we made didn&#x27;t affect any other scenarios which used to work until now? or if it affected any other parts of the app? or if it drastically slowed down the app?</p><p>This is one of the reasons why we need a proper set of tests for the app. Although it may seem like writing tests slows down development it usually pays off pretty fast.</p></main></article></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/blog/2021-01-24-multiplayer-tetris-game-part-2","query":{},"buildId":"xQ9F5DGep0bEZ6xm9hk0A","nextExport":true,"autoExport":true,"isFallback":false}</script><script nomodule="" src="/_next/static/chunks/polyfills-4f07b0c20fc9b3d5aa59.js"></script><script src="/_next/static/chunks/main-45110e586e5b9bc00f35.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.cdbdac0a36200f52203c.js" async=""></script><script src="/_next/static/chunks/afe4269f325c6b8604421e2a8f7bec7a7b2019c2.6c26eafa6145d614ef25.js" async=""></script><script src="/_next/static/chunks/3ef630e34cd10ba68f9d468ac363ff81c534e1e9.4a5474eceaa2247b7ab4.js" async=""></script><script src="/_next/static/chunks/pages/_app-f02ce07924e8fedfef57.js" async=""></script><script src="/_next/static/chunks/ec66151a9e4e24d8cdbbe349a286441475ff64c5.7ffadac7dd0f7e019b2c.js" async=""></script><script src="/_next/static/chunks/pages/blog/2021-01-24-multiplayer-tetris-game-part-2-6a1cc666820199740850.js" async=""></script><script src="/_next/static/xQ9F5DGep0bEZ6xm9hk0A/_buildManifest.js" async=""></script><script src="/_next/static/xQ9F5DGep0bEZ6xm9hk0A/_ssgManifest.js" async=""></script></body></html>