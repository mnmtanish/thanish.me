<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><title>Thanish.me - Running async tasks sequentially</title><meta name="description" content="Let’s check this badly written example first. The sequence below will run each step asynchronously."/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/e9e02a87a4c5bda8b576.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e9e02a87a4c5bda8b576.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-45110e586e5b9bc00f35.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.cdbdac0a36200f52203c.js" as="script"/><link rel="preload" href="/_next/static/chunks/afe4269f325c6b8604421e2a8f7bec7a7b2019c2.6c26eafa6145d614ef25.js" as="script"/><link rel="preload" href="/_next/static/chunks/3ef630e34cd10ba68f9d468ac363ff81c534e1e9.4a5474eceaa2247b7ab4.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-054f777325865917245d.js" as="script"/><link rel="preload" href="/_next/static/chunks/ec66151a9e4e24d8cdbbe349a286441475ff64c5.2f985208f1a91fdb0020.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/2017-01-09-running-async-tasks-sequentially-7438d004b62f814b7c54.js" as="script"/></head><body><div id="__next"><main><content class="markdown-body"><article><header id="navbar"><a id="link-home" href="/"><img src="/logo-192.png" alt="Homepage" width="48px" height="48px"/></a></header><header><h1>Running async tasks sequentially</h1><p class="post-meta"><small>Posted on <!-- -->2017-01-09</small></p><main><section><p>Let’s check this badly written example first. The sequence below will run each step asynchronously.</p></section></main></header><main><p>Let’s check this badly written example first. The sequence below will run each step asynchronously.</p><pre><code class="language-js">// y = 2 * (x² + 5)
const s1 = [
  x =&gt; Promise.resolve(x * x),
  x =&gt; Promise.resolve(x + 5),
  x =&gt; Promise.resolve(x * 2),
]

function runSequence(sequence, data) {
  return sequence.reduce((previous, task) =&gt; {
    return Promise.resolve(previous).then(task)
  }, data)
}

await runSequence(s1, 5)
</code></pre><p>In this example, we want the result of the previous stage to get passed on as input to the following stage. The runSequence helper function connects these tasks together.</p><p>What if we need the initial data in a later stage? to do that, we need to add a transformer function to runSequence. Let’s change the previous example problem so that we’ll need the initial value in a later stage.</p><pre><code class="language-js">// y = 2 * (x² + 5) + x
const s2 = [
  x =&gt; Promise.resolve(x * x),
  x =&gt; Promise.resolve(x + 5),
  x =&gt; Promise.resolve(x * 2),
  v =&gt; Promise.resolve(v.prev + v.data),
]

function runSequence(sequence, data, transformer) {
  return sequence.reduce((prev, task, idx) =&gt; {
    return Promise.resolve(prev)
      .then(prevVal =&gt; transformer(idx, prevVal, data))
      .then(task)
  }, data)
}

await runSequence(s2, 5, function (stage, prev, data) {
  switch (stage) {
    case 3:
      return { prev, data }
    default:
      return prev
  }
})
</code></pre><p>We can take it a step further and give the transformer an array of all results up to the current executing stage.</p><pre><code class="language-js">// y = 2 * (x² + 5) + x²
const s3 = [
  x =&gt; Promise.resolve(x * x),
  x =&gt; Promise.resolve(x + 5),
  x =&gt; Promise.resolve(x * 2),
  v =&gt; Promise.resolve(v.prev + v.sqrd),
]

function runSequence(sequence, data, transformer) {
  const results = []
  return sequence.reduce((prev, task, idx) =&gt; {
    return Promise.resolve(prev)
      .then(prevVal =&gt; transformer(idx, prevVal, data, results))
      .then(task)
      .then(res =&gt; {
        results.push(res)
        return res
      })
  }, data)
}

await runSequence(s3, 5, function (stage, prev, data, results) {
  switch (stage) {
    case 3:
      // reuse x² from result of stage 1
      return { prev, sqrd: results[0] }
    default:
      return prev
  }
})
</code></pre><p>If you&#x27;re using RxJS, this can be done using both concat and defer.</p><pre><code class="language-js">Observable.of()
    .concat( Observable.defer(() =&gt; asyncTask()))
    .concat( Observable.defer(() =&gt; asyncTask()))
</code></pre></main></article></content></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/blog/2017-01-09-running-async-tasks-sequentially","query":{},"buildId":"cMZ193JEUBCd4etmp-2xq","nextExport":true,"autoExport":true,"isFallback":false}</script><script nomodule="" src="/_next/static/chunks/polyfills-4f07b0c20fc9b3d5aa59.js"></script><script src="/_next/static/chunks/main-45110e586e5b9bc00f35.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.cdbdac0a36200f52203c.js" async=""></script><script src="/_next/static/chunks/afe4269f325c6b8604421e2a8f7bec7a7b2019c2.6c26eafa6145d614ef25.js" async=""></script><script src="/_next/static/chunks/3ef630e34cd10ba68f9d468ac363ff81c534e1e9.4a5474eceaa2247b7ab4.js" async=""></script><script src="/_next/static/chunks/pages/_app-054f777325865917245d.js" async=""></script><script src="/_next/static/chunks/ec66151a9e4e24d8cdbbe349a286441475ff64c5.2f985208f1a91fdb0020.js" async=""></script><script src="/_next/static/chunks/pages/blog/2017-01-09-running-async-tasks-sequentially-7438d004b62f814b7c54.js" async=""></script><script src="/_next/static/cMZ193JEUBCd4etmp-2xq/_buildManifest.js" async=""></script><script src="/_next/static/cMZ193JEUBCd4etmp-2xq/_ssgManifest.js" async=""></script></body></html>